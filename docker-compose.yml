services:
  ag3ntum-api:
    image: ag3ntum:${AG3NTUM_IMAGE_TAG:-latest}
    build: .
    command:
      - python
      - -m
      - uvicorn
      - src.api.main:app
      - --host=0.0.0.0
      - --port=40080
    environment:
      AG3NTUM_ROOT: "/"
      PYTHONPATH: "/"
    volumes:
      - ./config:/config
      - ./data:/data
      - ./logs:/logs
      - ./src:/src
      - ./users:/users
      - ./prompts:/prompts:ro
      - ./skills:/skills:ro
      - ./tools:/tools:ro
      - ./tests:/tests:ro  # Tests mounted read-only for ./deploy.sh test
    ports:
      - "${AG3NTUM_API_PORT:-40080}:40080"
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined

  ag3ntum-web:
    image: ag3ntum:${AG3NTUM_IMAGE_TAG:-latest}
    build: .
    entrypoint: ["/entrypoint-web.sh"]
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "50080"]
    working_dir: /src/web_terminal_client
    environment:
      AG3NTUM_ROOT: "/"
      PYTHONPATH: "/"
      AG3NTUM_WEB_PORT: "50080"
    volumes:
      - ./config:/config
      - ./logs:/logs
      - ./src:/src
      - web_node_modules:/src/web_terminal_client/node_modules
    ports:
      - "${AG3NTUM_WEB_PORT:-50080}:50080"
    depends_on:
      - ag3ntum-api
      - redis

  redis:
    image: redis:7-alpine
    command:
      - redis-server
      - --save
      - ""
      - --appendonly
      - "no"
    ports:
      - "127.0.0.1:46379:6379"

volumes:
  web_node_modules:
