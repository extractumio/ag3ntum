# Ag3ntum Docker Compose Configuration
#
# Environment Variables:
#   AG3NTUM_IMAGE_TAG  - Docker image tag (default: latest)
#   AG3NTUM_API_PORT   - API port on host (default: 40080)
#   AG3NTUM_WEB_PORT   - Web UI port on host (default: 50080)
#
# Usage:
#   ./run.sh build           # Build and start (handles permissions automatically)
#   docker compose up -d     # Start existing containers
#   docker compose down      # Stop containers
#
# See QUICK-START-GUIDE.md for detailed deployment instructions.

services:
  ag3ntum-api:
    image: ag3ntum:${AG3NTUM_IMAGE_TAG:-latest}
    build: .
    # Runs as ag3ntum_api (UID 45045) as defined in Dockerfile
    # Do NOT override with user: directive - breaks sudo inside container
    command:
      - python
      - -m
      - uvicorn
      - src.api.main:app
      - --host=0.0.0.0
      - --port=40080
    environment:
      AG3NTUM_ROOT: "/"
      PYTHONPATH: "/"
    volumes:
      - ./config:/config
      - ./data:/data
      - ./logs:/logs
      - ./src:/src
      - ./users:/users
      - ./prompts:/prompts:ro
      - ./skills:/skills:ro
      - ./tools:/tools:ro
      - ./tests:/tests:ro
    ports:
      - "${AG3NTUM_API_PORT:-40080}:40080"
    cap_add:
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
      - seccomp:unconfined
    depends_on:
      - redis
    restart: unless-stopped

  ag3ntum-web:
    image: ag3ntum:${AG3NTUM_IMAGE_TAG:-latest}
    build: .
    # Runs as ag3ntum_api (UID 45045) as defined in Dockerfile
    entrypoint: ["/entrypoint-web.sh"]
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "50080"]
    working_dir: /src/web_terminal_client
    environment:
      AG3NTUM_ROOT: "/"
      PYTHONPATH: "/"
      AG3NTUM_WEB_PORT: "50080"
      npm_config_cache: /tmp/.npm
    volumes:
      - ./config:/config
      - ./logs:/logs
      - ./src:/src
    ports:
      - "${AG3NTUM_WEB_PORT:-50080}:50080"
    depends_on:
      - ag3ntum-api
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "127.0.0.1:46379:6379"
    restart: unless-stopped
