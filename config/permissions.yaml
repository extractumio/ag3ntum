# Permission profile for Ag3ntum agent.
# Loaded once at startup and used throughout execution.
#
# Native Claude Code tools (Read, Write, Bash, etc.) are BLOCKED.
# All file/command operations go through Ag3ntum MCP tools which have:
# - Ag3ntumPathValidator for Python file tools (Ag3ntumRead/Write/Edit/etc.)
# - Bubblewrap sandbox for subprocess execution (Ag3ntumBash)

name: user
description: User profile for task execution with Ag3ntum tools.
defaultMode: default

tools:
  # Ag3ntum MCP tools - these replace native Claude Code tools
  # They have built-in security (PathValidator + bwrap sandbox)
  enabled:
    # Ag3ntum file tools (use PathValidator)
    - mcp__ag3ntum__Read
    - mcp__ag3ntum__Write
    - mcp__ag3ntum__Edit
    - mcp__ag3ntum__MultiEdit
    - mcp__ag3ntum__Glob
    - mcp__ag3ntum__Grep
    - mcp__ag3ntum__LS
    # Ag3ntum command tool (uses bwrap sandbox)
    - mcp__ag3ntum__Bash
    # Ag3ntum network tool (uses domain blocklist)
    - mcp__ag3ntum__WebFetch
    # Native tools that don't need replacement
    - Task
    - Skill
    - TodoRead
    - TodoWrite
    - NotebookEdit
    - WebSearch
    
  # BLOCKED: Native Claude Code tools - replaced by Ag3ntum versions
  disabled:
    - Bash      # Use mcp__ag3ntum__Bash instead
    - Read      # Use mcp__ag3ntum__Read instead
    - Write     # Use mcp__ag3ntum__Write instead
    - Edit      # Use mcp__ag3ntum__Edit instead
    - MultiEdit # Use mcp__ag3ntum__MultiEdit instead
    - Glob      # Use mcp__ag3ntum__Glob instead
    - Grep      # Use mcp__ag3ntum__Grep instead
    - LS        # Use mcp__ag3ntum__LS instead
    - WebFetch  # Use mcp__ag3ntum__WebFetch instead
    
  # Legacy: permission checking is now done by tools themselves
  permission_checked: []

session_workspace:
  description: |
    LEGACY: Pattern-based permissions are no longer the primary security layer.
    Security is now enforced by:
    1. Bubblewrap mount namespace (for Ag3ntumBash subprocesses)
    2. Ag3ntumPathValidator (for Python file tools like Ag3ntumRead/Write/Edit)
    3. Native Claude Code tools are blocked via tools.disabled
    
    These patterns are kept for backward compatibility but Ag3ntum tools
    handle their own validation.
  allow:
    # Allow all Ag3ntum tools (they have built-in security)
    - mcp__ag3ntum__Bash(*)
    - mcp__ag3ntum__Read(*)
    - mcp__ag3ntum__Write(*)
    - mcp__ag3ntum__Edit(*)
    - mcp__ag3ntum__MultiEdit(*)
    - mcp__ag3ntum__Glob(*)
    - mcp__ag3ntum__Grep(*)
    - mcp__ag3ntum__LS(*)
    - mcp__ag3ntum__WebFetch(*)
    # Other allowed tools
    - Task
    - Skill
    - TodoRead
    - TodoWrite
    - NotebookEdit
    - WebSearch
    
  deny:
    # Block ALL native Claude Code tools - use Ag3ntum versions instead
    - Bash(*)
    - Read(*)
    - Write(*)
    - Edit(*)
    - MultiEdit(*)
    - Glob(*)
    - Grep(*)
    - LS(*)
    - WebFetch(*)
    
  allowed_dirs:
    - "{workspace}"

# Sandbox configuration (bubblewrap). Toggle for non-docker runs as needed.
# Skills are discovered via SDK native discovery from workspace/.claude/skills/
# Symlinks in workspace point to actual skill directories which must be mounted.
#
# SECURITY NOTE: Network data transfer tools (curl, wget, ssh, scp, etc.) are
# blocked by Command Security Filter in config/security/command_filtering.yaml
# (category: network_data_transfer). Agents should use mcp__ag3ntum__WebFetch
# for allowed network requests, which enforces domain allowlisting.
sandbox:
  enabled: true
  file_sandboxing: true
  network_sandboxing: true
  bwrap_path: "bwrap"
  use_tmpfs_root: true

  # /proc filtering configuration (security enhancement for nested containers)
  # When enabled, agents cannot see other processes or read their environments
  proc_filtering:
    enabled: true  # Recommended: true (hides processes from agents)
    allowed_entries:
      # Essential entries for process operation
      - "/proc/self"      # Own process info (required for many tools)

      # Safe system information (read-only, no sensitive data)
      - "/proc/cpuinfo"   # CPU information
      - "/proc/meminfo"   # Memory statistics
      - "/proc/uptime"    # System uptime
      - "/proc/version"   # Kernel version

      # Optional: Uncomment if needed by specific skills
      # - "/proc/loadavg"   # Load average
      # - "/proc/stat"      # System statistics
      # - "/proc/diskstats" # Disk I/O statistics

    # Note: When enabled, commands like ps/top/htop won't work inside agent sandbox
    # This is expected and improves security (principle of least privilege)

  static_mounts:
    # System binaries (read-only)
    system_usr:
      source: "/usr"
      target: "/usr"
      mode: ro
    system_lib:
      source: "/lib"
      target: "/lib"
      mode: ro
    system_bin:
      source: "/bin"
      target: "/bin"
      mode: ro
  session_mounts:
    # Session workspace (read-write)
    workspace:
      source: "/users/{username}/sessions/{session_id}/workspace"
      target: "/workspace"
      mode: rw
    # Global skills - mounted so symlinks in workspace can resolve (read-only)
    # Symlinks point to {skills_dir}/.claude/skills/<skill_name>
    global_skills:
      source: "{skills_dir}/.claude/skills"
      target: "{skills_dir}/.claude/skills"
      mode: ro
    # User skills - mounted so symlinks in workspace can resolve (read-only)
    # Symlinks point to /users/{username}/.claude/skills/<skill_name>
    user_skills:
      source: "/users/{username}/.claude/skills"
      target: "/users/{username}/.claude/skills"
      mode: ro
  dynamic_mounts: []
  network:
    enabled: true
    allowed_domains: []
    allow_localhost: true
  environment:
    home: "/workspace"
    path: "/usr/bin:/bin"
    clear_env: true
  writable_paths:
    - "/workspace"
  readonly_paths:
    - "{skills_dir}/.claude/skills"
    - "/users/{username}/.claude/skills"
    - "/usr"
    - "/lib"
    - "/bin"

# File checkpointing configuration
checkpointing:
  # Tools that trigger automatic checkpoint creation after execution
  auto_checkpoint_tools:
    - Write
    - Edit
    - MultiEdit
